<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=7.4.0">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="[TOC] 基础 Series数据类型numpy的一维数组(array)和对应的一个索引组成,也类似于python数据类型里的字典1234567891011121314151617181920#列表、字典和Series的转化s1 = pd.Series([1,3,5,7],index=[&amp;quot;a&amp;quot;,&amp;quot;b&amp;quot;,&amp;quot;c&amp;quot;,&amp;quot;d&amp;quot;]">
<meta name="keywords" content="python,java,爬虫,数据分析">
<meta property="og:type" content="article">
<meta property="og:title" content="perfey">
<meta property="og:url" content="http://yoursite.com/2019/09/27/pandas使用/index.html">
<meta property="og:site_name" content="perfey">
<meta property="og:description" content="[TOC] 基础 Series数据类型numpy的一维数组(array)和对应的一个索引组成,也类似于python数据类型里的字典1234567891011121314151617181920#列表、字典和Series的转化s1 = pd.Series([1,3,5,7],index=[&amp;quot;a&amp;quot;,&amp;quot;b&amp;quot;,&amp;quot;c&amp;quot;,&amp;quot;d&amp;quot;]">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-09-27T10:04:24.412Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="perfey">
<meta name="twitter:description" content="[TOC] 基础 Series数据类型numpy的一维数组(array)和对应的一个索引组成,也类似于python数据类型里的字典1234567891011121314151617181920#列表、字典和Series的转化s1 = pd.Series([1,3,5,7],index=[&amp;quot;a&amp;quot;,&amp;quot;b&amp;quot;,&amp;quot;c&amp;quot;,&amp;quot;d&amp;quot;]">
  <link rel="canonical" href="http://yoursite.com/2019/09/27/pandas使用/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title> | perfey</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">perfey</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">个人博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

    

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a class="book-mark-link book-mark-link-fixed" href="#"></a>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/27/pandas使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="perfey">
      <meta itemprop="description" content="主要是学习工作中的笔记">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="perfey">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-09-27 18:04:24" itemprop="dateCreated datePublished" datetime="2019-09-27T18:04:24+08:00">2019-09-27</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[TOC]</p>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><ul>
<li>Series数据类型<br>numpy的一维数组(array)和对应的一个索引组成,也类似于python数据类型里的字典<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#列表、字典和Series的转化</span><br><span class="line"></span><br><span class="line">s1 = pd.Series([1,3,5,7],index=[&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;])</span><br><span class="line">s2=pd.Series(&#123;&quot;a&quot;:4,&quot;b&quot;:2,&quot;c&quot;:1,&quot;d&quot;:8&#125;)</span><br><span class="line">s1 +s2  # Series可以自动对齐,使得相同索引的值进行相加</span><br><span class="line">li = list(s1) # [1, 3, 5, 7]</span><br><span class="line">dic = dict(s1) #&#123;&apos;a&apos;: 1, &apos;b&apos;: 3, &apos;c&apos;: 5, &apos;d&apos;: 7&#125;</span><br><span class="line"></span><br><span class="line"># array和Series转化</span><br><span class="line">a1 = np.random.randint(0,10,(5,))  # 这是个一维数组 array类型</span><br><span class="line"># array([8, 5, 3, 4, 5])</span><br><span class="line">s1 = pd.Series(a1)</span><br><span class="line">索引 值</span><br><span class="line">0    8</span><br><span class="line">1    9</span><br><span class="line">2    4</span><br><span class="line">3    4</span><br><span class="line">4    9</span><br><span class="line">np.array(s1)   # 转化会numpy类型</span><br><span class="line"># array([8, 9, 4, 4, 9])</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">%%time</span><br><span class="line"># 统计一个月内站子微博内容包含 公益 或者 应援的 个数</span><br><span class="line">data = []</span><br><span class="line">for i in db.starcomm.find().sort([(&quot;_id&quot;,1)]): </span><br><span class="line">    ret = &#123;&#125;</span><br><span class="line">    ret[&quot;name&quot;] = i.get(&quot;name&quot;)   </span><br><span class="line">    ret[&quot;sum&quot;] = db[i.get(&quot;table&quot;)].find(&#123;&quot;publish_time&quot;: &#123;&quot;$gt&quot;: &quot;2019-06-00&quot;,&quot;$lt&quot;:&quot;2019-07-01&quot;&#125;&#125;,&#123;&quot;_id&quot;:0,&quot;content&quot;:1&#125;).count()</span><br><span class="line">    res = db[i.get(&quot;table&quot;)].find(&#123;&quot;publish_time&quot;: &#123;&quot;$gt&quot;: &quot;2019-06-00&quot;,&quot;$lt&quot;:&quot;2019-07-01&quot;&#125;&#125;,&#123;&quot;_id&quot;:0,&quot;content&quot;:1&#125;)</span><br><span class="line">    df = pd.DataFrame(res)</span><br><span class="line">    # df.content.str.contains(&quot;公益&quot;) 得到的是个bool的Series</span><br><span class="line">    ret[&quot;gongyi&quot;] = df[df.content.str.contains(&quot;公益&quot;)][&quot;content&quot;].count()  # 也可匹配正则</span><br><span class="line">    ret[&quot;yingyuan&quot;] =  df[df.content.str.contains(&quot;应援&quot;)][&quot;content&quot;].count()</span><br><span class="line">    print(ret)</span><br><span class="line">    data.append(ret)</span><br><span class="line">df = pd.DataFrame(data)</span><br><span class="line">df.to_excel(&quot;站子统计2.xlsx&quot;,index=0)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># pandas 转化为excel参数,是否包含索引,选择的列,给列重新起名字</span><br><span class="line">df.to_excel(f&quot;spider/download/&#123;table&#125;-&#123;name&#125;.xlsx&quot;.format(table=table, name=name), index=False,</span><br><span class="line">                            columns=[&quot;user&quot;, &quot;uid&quot;, &quot;mid&quot;, &quot;publish_time&quot;, &quot;content&quot;, &quot;forward&quot;, &quot;comment&quot;, &quot;like&quot;],</span><br><span class="line">                            header=[&quot;姓名&quot;, &quot;id&quot;,&quot;微博id&quot;, &quot;发布时间&quot;,&quot;内容&quot;, &quot;转发数&quot;,&quot;评论数&quot;, &quot;点赞数&quot; ]</span><br><span class="line">                            )</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import pandas as pd</span><br><span class="line">df1 = pd.read_excel(&quot;姚弛.xlsx&quot;,sheet_name=0)</span><br><span class="line">df2 = pd.read_excel(&quot;姚弛去重后.xlsx&quot;,sheet_name=0)</span><br><span class="line"># 写入同一个excel的多个工作簿</span><br><span class="line">write = pd.ExcelWriter(&quot;t2.xlsx&quot;)</span><br><span class="line">df1.to_excel(write,&quot;a&quot;)</span><br><span class="line">df2.to_excel(write,&quot;b&quot;)</span><br><span class="line">write.save()</span><br><span class="line"></span><br><span class="line">df = pd.read_excel(&quot;test.xls&quot;,sheet_name=1)# sheet_name 选择工作簿,可以根据索引选择,也可以根据名字选择</span><br></pre></td></tr></table></figure>

<ul>
<li><p>对 excel数据的两个字段进行排序,使用openpyxl修改pandas导出后的excel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">res = list(</span><br><span class="line">	db[table].find(&#123;&quot;star_name&quot;: &#123;&quot;$regex&quot;: name&#125;&#125;, &#123;&quot;_id&quot;: 0&#125;).sort([(&quot;_id&quot;, -1)]).limit(1000))</span><br><span class="line">name = name.replace(&quot;.*&quot;, &quot;all&quot;)</span><br><span class="line">df = pd.DataFrame(res)</span><br><span class="line">df = df[~df[&quot;type2&quot;].isna()]  # 去除没有分类的空值, ~ 取反,isna()是否为空</span><br><span class="line">df[&quot;followers_count&quot;] = df[&quot;followers_count&quot;].astype(int)</span><br><span class="line">df.sort_values(by=&quot;followers_count&quot;, axis=0, ascending=False, inplace=True,</span><br><span class="line">			   kind=&apos;mergesort&apos;)  # 使用桶排,保留原有顺序,ascending=False降序,inplace=True替换现有表格</span><br><span class="line">df[&quot;type_sorted&quot;] = df[&quot;type2&quot;].apply(</span><br><span class="line">	lambda i: 1 if i == &quot;个人KOL&quot; or i == &quot;个人kol&quot; or i == &quot;kol&quot; else 0)  # 新建一个字段用来排序</span><br><span class="line">df.sort_values(by=&quot;type_sorted&quot;, axis=0, ascending=True, inplace=True, kind=&apos;mergesort&apos;, )</span><br><span class="line">df.to_excel(f&quot;spider/download/&#123;table&#125;-&#123;name&#125;.xlsx&quot;.format(table=table, name=name), index=False, startrow=1,</span><br><span class="line">			merge_cells=True,</span><br><span class="line">			columns=[&quot;screen_name&quot;, &quot;gender&quot;, &quot;followers_count&quot;,</span><br><span class="line">					 &quot;type1&quot;, &quot;type2&quot;],</span><br><span class="line">			header=[&quot;昵称&quot;, &quot;性别&quot;, &quot;粉丝数&quot;, &quot;大分类&quot;, &quot;小分类&quot;], )</span><br><span class="line">workbook = openpyxl.load_workbook(f&quot;spider/download/&#123;table&#125;-&#123;name&#125;.xlsx&quot;.format(table=table, name=name))</span><br><span class="line">worksheet = workbook.worksheets[0]</span><br><span class="line">worksheet.merge_cells(&apos;A1:E1&apos;)</span><br><span class="line">worksheet.cell(1, 1, f&apos;&#123;name&#125;站子及kol数据&apos;)</span><br><span class="line">workbook.save(filename=f&quot;spider/download/&#123;table&#125;-&#123;name&#125;.xlsx&quot;.format(table=table, name=name))</span><br></pre></td></tr></table></figure>
</li>
<li><p>按类别排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">list_sorted = [&quot;综合站&quot;,&quot;综合&quot;,&quot;后援会组&quot;,&quot;反黑站&quot;,&quot;反黑&quot;,&quot;控评组&quot;,&quot;公益站&quot;,&quot;公益&quot;,&quot;应援站&quot;,&quot;应援&quot;,&quot;法援站&quot;,&quot;数据站&quot;,&quot;数据&quot;,&quot;打投组&quot;,&quot;打投&quot;,&quot;产出站&quot;,&quot;产出&quot;,&quot;时尚站&quot;,&quot;时尚&quot;,&quot;图站&quot;,&quot;图&quot;,&quot;资源博&quot;,&quot;地区粉丝团&quot;,&quot;个人kol&quot;,&quot;kol&quot;,&quot;个人KOL&quot;,]</span><br><span class="line">df[&apos;type2&apos;] = df[&apos;type2&apos;].astype(&apos;category&apos;).cat.set_categories(list_sorted)</span><br><span class="line">df = df.sort_values(by=[&apos;type2&apos;], ascending=True)</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df.reset_index(drop=True,inplace=True,)  # 重置索引,从0开始</span><br><span class="line">df[&quot;序号&quot;] =  np.arange(1, len(df)+1)  # 增加序号字段,从1开始</span><br><span class="line">df[&quot;序号&quot;]= df.index +1  # 也可重置索引后使用这种方法增加序号字段,从1开始</span><br></pre></td></tr></table></figure>
</li>
<li><p>取上一行的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#这一行数据1&gt;数据2 AND 数据1的上一行&lt;数据2的上一行</span><br><span class="line">#例如上例子，6&gt;3 AND 4&lt;5 则输出 产品C</span><br><span class="line">#shift(0):当前行</span><br><span class="line">#shift(1):前一行</span><br><span class="line">#shift(n):往前第n行</span><br><span class="line">df = pd.DataFrame(&#123;&apos;产品&apos;: [&apos;A&apos;,&apos;B&apos;,&apos;C&apos;],</span><br><span class="line">                   &apos;数据1&apos;: [1, 4, 6],</span><br><span class="line">                   &apos;数据2&apos;: [2, 5, 3]&#125;)</span><br><span class="line"></span><br><span class="line">  产品	数据1	数据2</span><br><span class="line">0	A	1	2</span><br><span class="line">1	B	4	5</span><br><span class="line">2	C	6	3</span><br><span class="line">df[(df[&apos;数据1&apos;].shift(1) &lt; df[&apos;数据2&apos;].shift(1)) &amp; (df[&apos;数据1&apos;].shift(0) &gt; df[&apos;数据2&apos;].shift(0))][&apos;产品&apos;]</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line">import pandas as pd</span><br><span class="line"> </span><br><span class="line">df = pd.DataFrame(&#123;&apos;date&apos;: [&apos;20150101&apos;,&apos;20150102&apos;,&apos;20150103&apos;,&apos;20150104&apos;,&apos;20150105&apos;,&apos;20150106&apos;],</span><br><span class="line">                   &apos;A&apos;: [8,10,9,11,11,12],</span><br><span class="line">                   &apos;B&apos;: [7,9,8,11,10,10],</span><br><span class="line">                   &apos;M&apos;: [7.5,9.5,8.5,11,10.5,11],</span><br><span class="line">                   &apos;S&apos;: [0,-1,1,0,0,-1]&#125;)</span><br><span class="line"></span><br><span class="line">df = df.reindex(columns=[&apos;date&apos;,&apos;A&apos;,&apos;B&apos;,&apos;M&apos;,&apos;S&apos;]) # 重建索引</span><br><span class="line">df</span><br><span class="line">      date	  A	  B	  M	S</span><br><span class="line">0	20150101	8	7	7.5	0</span><br><span class="line">1	20150102	10	9	9.5	-1</span><br><span class="line">2	20150103	9	8	8.5	1</span><br><span class="line">3	20150104	11	11	11.0	0</span><br><span class="line">4	20150105	11	10	10.5	0</span><br><span class="line">5	20150106	12	10	11.0	-1</span><br><span class="line"># if S &lt; 0, cost = (M-B).shift(1)*S</span><br><span class="line"># if S &gt; 0, cost = (M-A).shift(1)*S</span><br><span class="line"># if S == 0, cost=0</span><br><span class="line">方法一:</span><br><span class="line">df[&apos;cost&apos;] = np.where(df[&apos;S&apos;] &lt; 0,</span><br><span class="line">                      np.roll((df[&apos;M&apos;]-df[&apos;B&apos;]), 1)*df[&apos;S&apos;],</span><br><span class="line">                      np.where(df[&apos;S&apos;] &gt; 0,</span><br><span class="line">                               np.roll((df[&apos;M&apos;]-df[&apos;A&apos;]), 1)*df[&apos;S&apos;],</span><br><span class="line">                               0)</span><br><span class="line">                     )</span><br><span class="line">方法二:</span><br><span class="line">M, A, B, S = [df[col] for col in &apos;MABS&apos;]</span><br><span class="line">conditions = [S &lt; 0, S &gt; 0]</span><br><span class="line">choices = [(M-B).shift(1)*S, (M-A).shift(1)*S]</span><br><span class="line">df[&apos;cost2&apos;] = np.select(conditions, choices, default=0)</span><br></pre></td></tr></table></figure>

<p>分片,统计数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line">import pandas as pd</span><br><span class="line">values = np.random.rand(10)</span><br><span class="line">values</span><br><span class="line">array([0.87058577, 0.48406958, 0.28367199, 0.61107191, 0.85048026,</span><br><span class="line">       0.53127231, 0.14198227, 0.33746115, 0.47544542, 0.00764242])</span><br><span class="line"></span><br><span class="line">bins = [0,0.2,0.4,0.6,0.8,1]</span><br><span class="line">pd.get_dummies(pd.cut(values,bins))</span><br><span class="line">(0.0, 0.2]  (0.2, 0.4]  (0.4, 0.6]  (0.6, 0.8]  (0.8, 1.0]</span><br><span class="line">0           0           0           0           0           1</span><br><span class="line">1           0           0           1           0           0</span><br><span class="line">2           0           1           0           0           0</span><br><span class="line">3           0           0           0           1           0</span><br><span class="line">4           0           0           0           0           1</span><br><span class="line">5           0           0           1           0           0</span><br><span class="line">6           1           0           0           0           0</span><br><span class="line">7           0           1           0           0           0</span><br><span class="line">8           0           0           1           0           0</span><br><span class="line">9           1           0           0           0           0</span><br><span class="line"></span><br><span class="line">pd.get_dummies(pd.cut(values,bins)).sum()</span><br><span class="line">(0.0, 0.2]    2</span><br><span class="line">(0.2, 0.4]    2</span><br><span class="line">(0.4, 0.6]    3</span><br><span class="line">(0.6, 0.8]    1</span><br><span class="line">(0.8, 1.0]    2</span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import json</span><br><span class="line">db = json.load(open(&quot;database.json&quot;))</span><br><span class="line">nutrients = pd.DataFrame(db[0][&quot;nutrients&quot;])</span><br><span class="line">info_keys = [&quot;description&quot;,&quot;group&quot;,&quot;id&quot;,&quot;manufacturer&quot;]</span><br><span class="line">info = pd.DataFrame(db,columns=info_keys)</span><br><span class="line">pd.value_counts(info.group)</span><br><span class="line"></span><br><span class="line">nutrients = []</span><br><span class="line">for rec in db:</span><br><span class="line">    fnuts = pd.DataFrame(rec[&quot;nutrients&quot;])</span><br><span class="line">    fnuts[&quot;id&quot;] = rec[&quot;id&quot;]</span><br><span class="line">    nutrients.append(fnuts)</span><br><span class="line">nutrients = pd.concat(nutrients,ignore_index=True)</span><br><span class="line">nutrients.duplicated().sum() # 重复值的个数</span><br><span class="line">nutrients = nutrients.drop_duplicates()  #去重</span><br><span class="line"></span><br><span class="line">col_mapping = &#123;</span><br><span class="line">    &quot;description&quot; :&quot;food&quot;,</span><br><span class="line">    &quot;group&quot;:&quot;fgroup&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">info = info.rename(columns=col_mapping,copy=False)   # 重命名</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">col_mapping = &#123;</span><br><span class="line">    &quot;description&quot;:&quot;nutrient&quot;,</span><br><span class="line">    &quot;group&quot;:&quot;nutgroup&quot;</span><br><span class="line">&#125;</span><br><span class="line">nutrients = nutrients.rename(columns=col_mapping,copy=False)</span><br><span class="line"></span><br><span class="line">ndata = pd.merge(nutrients,info,on=&quot;id&quot;,how=&quot;outer&quot;)  # 合并</span><br><span class="line"></span><br><span class="line">ndata.ix[3]  # loc：通过行标签索引数据 ;  iloc：通过行号索引行数据  ; ix：通过行标签或行号索引数据（基于loc和iloc的混合）</span><br><span class="line"></span><br><span class="line">result= ndata.groupby([&quot;nutrient&quot;,&quot;fgroup&quot;])[&quot;value&quot;].quantile(0.5)  # 分位数</span><br><span class="line"></span><br><span class="line">by_nutrient = ndata.groupby([&quot;nutgroup&quot;,&quot;nutrient&quot;])</span><br><span class="line">get_maximum = lambda x:x.xs(x.value.idxmax())  # xs 按行索引的名字选择行 ; idxmax 方法用于获取 Series 的最大值的索引值</span><br><span class="line">get_minimum = lambda x:x.xs(x.value.idxmin())</span><br><span class="line">max_foods = by_nutrient.apply(get_maximum)[[&quot;value&quot;,&quot;food&quot;]]</span><br><span class="line">max_foods.food = max_foods.food.str[:50]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;&quot;key1&quot;:[&quot;a&quot;,&quot;a&quot;,&apos;b&apos;,&apos;b&apos;,&apos;a&apos;],&quot;key2&quot;:[&quot;one&quot;,&quot;two&quot;,&quot;one&quot;,&quot;two&quot;,&quot;one&quot;],&quot;data1&quot;:np.random.randn(5),&quot;data2&quot;:np.random.randn(5)&#125;)</span><br><span class="line"></span><br><span class="line">df</span><br><span class="line">key1	key2	data1	data2</span><br><span class="line">0	a	one	0.040481	1.420874</span><br><span class="line">1	a	two	1.158794	-1.534256</span><br><span class="line">2	b	one	-0.701728	0.933259</span><br><span class="line">3	b	two	-0.538727	0.503727</span><br><span class="line">4	a	one	1.245693	-1.553059</span><br><span class="line">grouped = df[&apos;data1&apos;].groupby(df[&quot;key1&quot;])</span><br><span class="line"></span><br><span class="line">grouped.mean()</span><br><span class="line">key1</span><br><span class="line">a    0.814990</span><br><span class="line">b   -0.620228</span><br><span class="line">Name: data1, dtype: float64</span><br><span class="line"></span><br><span class="line">means = df[&quot;data1&quot;].groupby([df[&quot;key1&quot;],df[&quot;key2&quot;]]).mean()</span><br><span class="line">means</span><br><span class="line">key1  key2</span><br><span class="line">a     one     0.643087</span><br><span class="line">      two     1.158794</span><br><span class="line">b     one    -0.701728</span><br><span class="line">      two    -0.538727</span><br><span class="line">Name: data1, dtype: float64</span><br><span class="line"></span><br><span class="line">means.unstack()</span><br><span class="line">key2	one	two</span><br><span class="line">key1		</span><br><span class="line">a	0.643087	1.158794</span><br><span class="line">b	-0.701728	-0.538727</span><br><span class="line"></span><br><span class="line">means.unstack(&quot;key1&quot;)</span><br><span class="line">key1	a	b</span><br><span class="line">key2		</span><br><span class="line">one	0.643087	-0.701728</span><br><span class="line">two	1.158794	-0.538727</span><br><span class="line"></span><br><span class="line">df</span><br><span class="line">key1	key2	data1	data2</span><br><span class="line">0	a	one	0.040481	1.420874</span><br><span class="line">1	a	two	1.158794	-1.534256</span><br><span class="line">2	b	one	-0.701728	0.933259</span><br><span class="line">3	b	two	-0.538727	0.503727</span><br><span class="line">4	a	one	1.245693	-1.553059</span><br><span class="line"></span><br><span class="line">states = np.array([&apos;Ohio&apos;,&apos;California&apos;,&apos;California&apos;,&apos;Ohio&apos;,&apos;Ohio&apos;])</span><br><span class="line">years = np.array([2005,2005,2006,2005,2005])</span><br><span class="line"></span><br><span class="line">df[&apos;data1&apos;].groupby([states,years]).mean()</span><br><span class="line">California  2005    1.158794</span><br><span class="line">            2006   -0.701728</span><br><span class="line">Ohio        2005    0.249149</span><br><span class="line">Name: data1, dtype: float64</span><br><span class="line"></span><br><span class="line">df.groupby(&apos;key1&apos;).mean()</span><br><span class="line">data1	data2</span><br><span class="line">key1		</span><br><span class="line">a	0.814990	-0.555480</span><br><span class="line">b	-0.620228	0.718493</span><br><span class="line"></span><br><span class="line">df.groupby([&apos;key1&apos;,&apos;key2&apos;]).size()</span><br><span class="line">key1  key2</span><br><span class="line">a     one     2</span><br><span class="line">      two     1</span><br><span class="line">b     one     1</span><br><span class="line">      two     1</span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">for name,group in df.groupby(&quot;key1&quot;)[&quot;key2&quot;]:</span><br><span class="line">    print(name)</span><br><span class="line">    print(group)</span><br><span class="line">a</span><br><span class="line">0    one</span><br><span class="line">1    two</span><br><span class="line">4    one</span><br><span class="line">Name: key2, dtype: object</span><br><span class="line">b</span><br><span class="line">2    one</span><br><span class="line">3    two</span><br><span class="line">Name: key2, dtype: object</span><br><span class="line"></span><br><span class="line">for (k1,k2),group in df.groupby([&quot;key1&quot;,&quot;key2&quot;]):</span><br><span class="line">    print(k1,k2)</span><br><span class="line">    print(group)</span><br><span class="line">a one</span><br><span class="line">  key1 key2     data1     data2</span><br><span class="line">0    a  one  0.040481  1.420874</span><br><span class="line">4    a  one  1.245693 -1.553059</span><br><span class="line">a two</span><br><span class="line">  key1 key2     data1     data2</span><br><span class="line">1    a  two  1.158794 -1.534256</span><br><span class="line">b one</span><br><span class="line">  key1 key2     data1     data2</span><br><span class="line">2    b  one -0.701728  0.933259</span><br><span class="line">b two</span><br><span class="line">  key1 key2     data1     data2</span><br><span class="line">3    b  two -0.538727  0.503727</span><br><span class="line"></span><br><span class="line">pieces = dict(list(df.groupby(&apos;key1&apos;)))  # 变成字典,取分组后切片</span><br><span class="line">pieces</span><br><span class="line">&#123;&apos;a&apos;:   key1 key2     data1     data2</span><br><span class="line"> 0    a  one  0.040481  1.420874</span><br><span class="line"> 1    a  two  1.158794 -1.534256</span><br><span class="line"> 4    a  one  1.245693 -1.553059, &apos;b&apos;:   key1 key2     data1     data2</span><br><span class="line"> 2    b  one -0.701728  0.933259</span><br><span class="line"> 3    b  two -0.538727  0.503727&#125;</span><br><span class="line"></span><br><span class="line">pieces[&quot;a&quot;]</span><br><span class="line">key1	key2	data1	data2</span><br><span class="line">0	a	one	0.040481	1.420874</span><br><span class="line">1	a	two	1.158794	-1.534256</span><br><span class="line">4	a	one	1.245693	-1.553059</span><br><span class="line"></span><br><span class="line"># 按列分组</span><br><span class="line">df.dtypes</span><br><span class="line">key1      object</span><br><span class="line">key2      object</span><br><span class="line">data1    float64</span><br><span class="line">data2    float64</span><br><span class="line">dtype: object</span><br><span class="line">grouped = df.groupby(df.dtypes,axis=1)</span><br><span class="line">dict(list(grouped))</span><br><span class="line">&#123;dtype(&apos;float64&apos;):       data1     data2</span><br><span class="line"> 0  0.040481  1.420874</span><br><span class="line"> 1  1.158794 -1.534256</span><br><span class="line"> 2 -0.701728  0.933259</span><br><span class="line"> 3 -0.538727  0.503727</span><br><span class="line"> 4  1.245693 -1.553059, dtype(&apos;O&apos;):   key1 key2</span><br><span class="line"> 0    a  one</span><br><span class="line"> 1    a  two</span><br><span class="line"> 2    b  one</span><br><span class="line"> 3    b  two</span><br><span class="line"> 4    a  one&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">df</span><br><span class="line">key1	key2	data1	data2</span><br><span class="line">0	a	one	0.014271	0.995202</span><br><span class="line">1	a	two	-1.214673	0.771752</span><br><span class="line">2	b	one	0.963552	-0.610659</span><br><span class="line">3	b	two	-1.238167	-0.779469</span><br><span class="line">4	a	one	-0.161038	0.297883</span><br><span class="line"></span><br><span class="line">for i in df.groupby(&apos;key1&apos;)[&quot;data2&quot;]:</span><br><span class="line">    print(i)</span><br><span class="line">(&apos;a&apos;, 0    0.995202</span><br><span class="line">1    0.771752</span><br><span class="line">4    0.297883</span><br><span class="line">Name: data2, dtype: float64)</span><br><span class="line">(&apos;b&apos;, 2   -0.610659</span><br><span class="line">3   -0.779469</span><br><span class="line">Name: data2, dtype: float64)</span><br><span class="line"></span><br><span class="line">for i in df.groupby(&apos;key1&apos;)[[&quot;data2&quot;]]:</span><br><span class="line">    print(i)</span><br><span class="line">(&apos;a&apos;,   key1 key2     data1     data2</span><br><span class="line">0    a  one  0.014271  0.995202</span><br><span class="line">1    a  two -1.214673  0.771752</span><br><span class="line">4    a  one -0.161038  0.297883)</span><br><span class="line">(&apos;b&apos;,   key1 key2     data1     data2</span><br><span class="line">2    b  one  0.963552 -0.610659</span><br><span class="line">3    b  two -1.238167 -0.779469)</span><br><span class="line"></span><br><span class="line">for i in df[[&quot;data2&quot;]].groupby(df[&apos;key1&apos;]):</span><br><span class="line">    print(i)</span><br><span class="line">(&apos;a&apos;,       data2</span><br><span class="line">0  0.995202</span><br><span class="line">1  0.771752</span><br><span class="line">4  0.297883)</span><br><span class="line">(&apos;b&apos;,       data2</span><br><span class="line">2 -0.610659</span><br><span class="line">3 -0.779469)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">people = pd.DataFrame(np.random.randn(5,5),columns=[&apos;a&apos;,&apos;b&apos;,&apos;c&apos;,&apos;d&apos;,&apos;e&apos;],index=[&apos;Joe&apos;,&apos;Steve&apos;,&apos;Wes&apos;,&apos;Jim&apos;,&apos;Travis&apos;])</span><br><span class="line">people</span><br><span class="line">a	b	c	d	e</span><br><span class="line">Joe	-0.168996	1.395623	0.554432	1.782690	0.434736</span><br><span class="line">Steve	-1.527405	-0.368840	0.788034	1.393361	0.106949</span><br><span class="line">Wes	-0.938562	0.974203	-0.764173	-0.120886	-1.032622</span><br><span class="line">Jim	-0.033004	0.050498	0.286138	0.990956	-0.863128</span><br><span class="line">Travis	-0.764984	-0.058035	-3.228946	-2.364380	0.083468</span><br><span class="line"></span><br><span class="line">people.ix[2:3,[&apos;b&apos;,&apos;c&apos;]] = np.nan   # 行索引2:3,列索引&apos;b&apos;,&apos;c&apos;设为nan</span><br><span class="line">people</span><br><span class="line">a	b	c	d	e</span><br><span class="line">Joe	-0.168996	1.395623	0.554432	1.782690	0.434736</span><br><span class="line">Steve	-1.527405	-0.368840	0.788034	1.393361	0.106949</span><br><span class="line">Wes	-0.938562	NaN	NaN	-0.120886	-1.032622</span><br><span class="line">Jim	-0.033004	0.050498	0.286138	0.990956	-0.863128</span><br><span class="line">Travis	-0.764984	-0.058035	-3.228946	-2.364380	0.083468</span><br><span class="line"></span><br><span class="line"># 以字典对组,将多个列对应一个组</span><br><span class="line">mapping = &#123;&apos;a&apos;:&apos;red&apos;,&apos;b&apos;:&apos;red&apos;,&apos;c&apos;:&apos;blue&apos;,&apos;d&apos;:&apos;blue&apos;,&apos;e&apos;:&apos;red&apos;,&apos;f&apos;:&apos;orange&apos;&#125;</span><br><span class="line">by_column = people.groupby(mapping,axis=1)</span><br><span class="line">by_column.sum()</span><br><span class="line">blue	red</span><br><span class="line">Joe	2.337122	1.661363</span><br><span class="line">Steve	2.181395	-1.789296</span><br><span class="line">Wes	-0.120886	-1.971185</span><br><span class="line">Jim	1.277094	-0.845634</span><br><span class="line">Travis	-5.593326	-0.739551</span><br><span class="line"></span><br><span class="line"># 使用Series类型分组</span><br><span class="line">map_servies = pd.Series(mapping)</span><br><span class="line">map_servies</span><br><span class="line">a       red</span><br><span class="line">b       red</span><br><span class="line">c      blue</span><br><span class="line">d      blue</span><br><span class="line">e       red</span><br><span class="line">f    orange</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">people.groupby(map_servies,axis=1).count()</span><br><span class="line">	blue	red</span><br><span class="line">Joe	2	3</span><br><span class="line">Steve	2	3</span><br><span class="line">Wes	1	2</span><br><span class="line">Jim	2	3</span><br><span class="line">Travis	2	3</span><br><span class="line"></span><br><span class="line"># 通过函数进行分组,更加灵活</span><br><span class="line">people.groupby(len).sum()  # 通过索引名长度对行进行分组</span><br><span class="line">a	b	c	d	e</span><br><span class="line">3	-1.140563	1.446122	0.840571	2.652759	-1.461015</span><br><span class="line">5	-1.527405	-0.368840	0.788034	1.393361	0.106949</span><br><span class="line">6	-0.764984	-0.058035	-3.228946	-2.364380	0.083468</span><br><span class="line"></span><br><span class="line"># 混合使用</span><br><span class="line">key_list = [&apos;one&apos;,&apos;one&apos;,&apos;one&apos;,&apos;two&apos;,&apos;two&apos;]</span><br><span class="line">people.groupby([len,key_list]).min()</span><br><span class="line">a	b	c	d	e</span><br><span class="line">3	one	-0.938562	1.395623	0.554432	-0.120886	-1.032622</span><br><span class="line">two	-0.033004	0.050498	0.286138	0.990956	-0.863128</span><br><span class="line">5	one	-1.527405	-0.368840	0.788034	1.393361	0.106949</span><br><span class="line">6	two	-0.764984	-0.058035	-3.228946	-2.364380	0.083468</span><br><span class="line"></span><br><span class="line"># 根据索引级别分组</span><br><span class="line">columns= pd.MultiIndex.from_arrays([[&apos;US&apos;,&apos;US&apos;,&apos;US&apos;,&apos;JP&apos;,&apos;JP&apos;],[1,3,5,1,3]],names=[&apos;cty&apos;,&apos;tenor&apos;])</span><br><span class="line">hier_df = pd.DataFrame(np.random.randn(4,5),columns=columns)</span><br><span class="line">hier_df</span><br><span class="line">      cty         US	           JP</span><br><span class="line">tenor	1	3	5	1	3</span><br><span class="line">0	0.097867	0.344498	0.319310	1.501781	-2.050167</span><br><span class="line">1	0.194749	-0.859610	1.357505	-2.789579	0.096479</span><br><span class="line">2	0.844357	-0.804864	-1.269237	0.158462	-0.126933</span><br><span class="line">3	-0.327278	1.108394	-1.627974	0.252040	0.614040</span><br><span class="line"></span><br><span class="line">hier_df.groupby(level=&apos;cty&apos;,axis=1).count()</span><br><span class="line">cty	JP	US</span><br><span class="line">0	2	3</span><br><span class="line">1	2	3</span><br><span class="line">2	2	3</span><br><span class="line">3	2	3</span><br><span class="line"></span><br><span class="line">hier_df.groupby(level=&apos;cty&apos;,axis=1).first()</span><br><span class="line">cty	JP	US</span><br><span class="line">0	1.501781	0.097867</span><br><span class="line">1	-2.789579	0.194749</span><br><span class="line">2	0.158462	0.844357</span><br><span class="line">3	0.252040	-0.327278</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">df</span><br><span class="line">	key1	key2	data1	data2</span><br><span class="line">0	a	one	-0.178398	0.809646</span><br><span class="line">1	a	two	-0.855168	0.124230</span><br><span class="line">2	b	one	-0.389141	-0.589644</span><br><span class="line">3	b	two	0.142801	-0.336199</span><br><span class="line">4	a	one	2.965736	0.252593</span><br><span class="line"></span><br><span class="line">grouped = df.groupby(&apos;key1&apos;)</span><br><span class="line">dict(list(grouped))</span><br><span class="line">&#123;&apos;a&apos;:   key1 key2     data1     data2</span><br><span class="line"> 0    a  one -1.347478 -0.582278</span><br><span class="line"> 1    a  two -0.188355  1.044322</span><br><span class="line"> 4    a  one -0.427903 -0.182019, &apos;b&apos;:   key1 key2     data1     data2</span><br><span class="line"> 2    b  one  0.656312 -0.391641</span><br><span class="line"> 3    b  two -0.114511  1.015607&#125;</span><br><span class="line"></span><br><span class="line">def peak_to_peak(arr):</span><br><span class="line">    return [round(i,2) for i in list(arr)]</span><br><span class="line"></span><br><span class="line">grouped.agg(peak_to_peak).loc[&apos;a&apos;,[&quot;data1&quot;]]</span><br><span class="line"></span><br><span class="line">data1    [-1.35, -0.19, -0.43]</span><br><span class="line">Name: a, dtype: object</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">查看每个客户应答为true后应答为false不多于2个的客户</span><br><span class="line">for name,group in df.groupby(&apos;客户号码&apos;):</span><br><span class="line">    </span><br><span class="line">    group.sort_values(by=&quot;呼出时间&quot;, axis=0, ascending=False, inplace=True,</span><br><span class="line">               kind=&apos;mergesort&apos;)</span><br><span class="line">    group.reset_index(drop=True,inplace=True,)</span><br><span class="line">    df2 = group[group[&quot;应答&quot;]]</span><br><span class="line">    if not df2.empty and (group.tail(1).index -df2.tail(1).index)&gt;2:</span><br><span class="line">        print(group.tail(1))</span><br><span class="line">        break</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">忽略警告设置</span><br><span class="line">pd.set_option(&apos;mode.chained_assignment&apos;, None)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from datetime import datetime, timedelta</span><br><span class="line">baidu = pd.DataFrame(db.baiduheat.find(&#123;&quot;name&quot;: name&#125;, &#123;&quot;_id&quot;: 0&#125;).limit(31).sort([(&quot;_id&quot;, -1)]))</span><br><span class="line">df1 = pd.DataFrame(db.weixinheat.find(&#123;&quot;name&quot;: name&#125;, &#123;&quot;_id&quot;: 0&#125;).sort([(&quot;_id&quot;, -1)]).limit(1))</span><br><span class="line">weibo = pd.DataFrame(db.weiheat.find(&#123;&quot;name&quot;: name&#125;,&#123;&quot;_id&quot;: 0&#125;).sort([(&quot;_id&quot;, -1)]).limit(31))</span><br><span class="line">df2 = pd.concat([pd.Series(row[&apos;weixin_index&apos;].split(&apos;,&apos;)) for _, row in df1.iterrows()]).reset_index()</span><br><span class="line">weixinheat = list(df2[0])</span><br><span class="line">weixinheat.reverse()</span><br><span class="line">df2[&quot;weixinheat&quot;] = weixinheat</span><br><span class="line">df2[&quot;date&quot;] = [(datetime.strptime(df1[&quot;date&quot;][0], &quot;%Y-%m-%d&quot;) - timedelta(days=i)).strftime(&apos;%Y-%m-%d&apos;) for</span><br><span class="line">               i in range(len(df2))]</span><br><span class="line">all = pd.merge(pd.merge(baidu, weibo, on=&quot;date&quot;, how=&quot;outer&quot;), df2, on=&quot;date&quot;, how=&quot;outer&quot;)</span><br><span class="line">final_all = all.head(30)</span><br><span class="line">final_all.drop([&quot;name_x&quot;, &quot;name_y&quot;, 0, &quot;media&quot;, &quot;uid&quot;, &quot;index&quot;], axis=1, inplace=True)   //删除不要的字段</span><br><span class="line">final_all.rename(index=str, inplace=True,</span><br><span class="line">                 columns=&#123;&quot;date&quot;: &quot;日期&quot;, &quot;message&quot;: &quot;资讯指数&quot;, &quot;search&quot;: &quot;搜索指数&quot;, &quot;weiheat&quot;: &quot;微博指数&quot;,</span><br><span class="line">                          &quot;weixinheat&quot;: &quot;微信指数&quot;&#125;)  //重命名</span><br><span class="line">res = json.loads(final_all.to_json(orient=&apos;records&apos;))  //dataframe转化为json</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/09/27/hexo-use/" rel="next" title="hexo-use">
                  <i class="fa fa-chevron-left"></i> hexo-use
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基础"><span class="nav-number">1.</span> <span class="nav-text">基础</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#方法"><span class="nav-number">2.</span> <span class="nav-text">方法</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">perfey</p>
  <div class="site-description" itemprop="description">主要是学习工作中的笔记</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">perfey</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/muse.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script><script src="/js/bookmark.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

</body>
</html>
